---
  machine:
    services:
      - docker

  checkout:
    post:
      - gcc --version
      - git submodule init
      - git submodule update
      - >
        docker login \
          -e ${DOCKER_HUB_EMAIL} \
          -u ${DOCKER_HUB_USER} \
          -p ${DOCKER_HUB_PASSWORD}

  dependencies:
    pre:
      - >
        sudo apt-get update && sudo apt-get install -y --no-install-recommends \
             patch \
             perl \
             tar \
             wget \
             cpio \
             python \
             unzip \
             rsync \
             bc \
             g++
    override:
      - make -f Makefile.toolchain
      - make -f Makefile.mongod
      - make -f Makefile.mongos

  test:
    pre:
      - docker build -t dockerslim/mongo:3.0.4-mongod ./project-mongod
      - docker build -t dockerslim/mongo:3.0.4-mongos ./project-mongos

  deployment:
    production:
      branch: master
      commands:
        - docker push dockerslim/mongo:3.0.4-mongod
        - docker push dockerslim/mongo:3.0.4-mongos
