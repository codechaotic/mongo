---
  machine:
    services:
      - docker
    environment:
      ORG: dockerslim
      REPO: mongo
      MAJOR: 3
      MINOR: 3.0
      PATCH: 3.0.5

  checkout:
    post:
      - git submodule init
      - git submodule update
      - >
        docker login \
          -e ${DOCKER_HUB_EMAIL} \
          -u ${DOCKER_HUB_USER} \
          -p ${DOCKER_HUB_PASSWORD}

  dependencies:
    cache_directories:
      - "toolchain/output"
      - "default/output"
    pre:
      - sudo apt-get update
      - sudo apt-get install -y --no-install-recommends bc
    override:
      - make -f Makefile.toolchain 2>&1 | tee ${CIRCLE_ARTIFACTS}/toolchain.log
      - make 2>&1 | tee ${CIRCLE_ARTIFACTS}/default.log

  test:
    pre:
      - cp default/output/images/rootfs.tar dockerfiles/default/
      - cp dockerfiles/default/rootfs.tar ${CIRCLE_ARTIFACTS}/default.tar
      - gzip ${CIRCLE_ARTIFACTS}/default.tar
      - docker build -t default ./dockerfiles/default
      - cp default/output/images/rootfs.tar dockerfiles/mongod/
      - >
        tar --delete -f dockerfiles/mongod/rootfs.tar \
            ./usr/local/bin/mongo \
            ./usr/local/bin/mongos \
            ./usr/local/bin/mongoperf
      - cp dockerfiles/mongod/rootfs.tar ${CIRCLE_ARTIFACTS}/mongod.tar
      - gzip ${CIRCLE_ARTIFACTS}/mongod.tar
      - docker build -t mongod ./dockerfiles/mongod
      - cp default/output/images/rootfs.tar dockerfiles/mongos/
      - >
        tar --delete -f dockerfiles/mongos/rootfs.tar\
            ./usr/local/bin/mongo \
            ./usr/local/bin/mongod \
            ./usr/local/bin/mongoperf
      - cp dockerfiles/mongos/rootfs.tar ${CIRCLE_ARTIFACTS}/mongos.tar
      - gzip ${CIRCLE_ARTIFACTS}/mongos.tar
      - docker build -t mongos ./dockerfiles/mongos
    override:
      - echo 'NYI'

  deployment:
    primary:
      branch: master
      owner: dockerslim
      commands:
        - >
          docker tag default ${ORG}/${REPO}; \
          docker tag default ${ORG}/${REPO}:${MAJOR}; \
          docker tag default ${ORG}/${REPO}:${MINOR}; \
          docker tag default ${ORG}/${REPO}:${PATCH}; \
          docker tag mongod ${ORG}/${REPO}:mongod; \
          docker tag mongod ${ORG}/${REPO}:mongod-${MAJOR}; \
          docker tag mongod ${ORG}/${REPO}:mongod-${MINOR}; \
          docker tag mongod ${ORG}/${REPO}:mongod-${PATCH}; \
          docker tag mongos ${ORG}/${REPO}:mongos; \
          docker tag mongos ${ORG}/${REPO}:mongos-${MAJOR}; \
          docker tag mongos ${ORG}/${REPO}:mongos-${MINOR}; \
          docker tag mongos ${ORG}/${REPO}:mongos-${PATCH}
        - >
          docker push ${ORG}/${REPO}; \
          docker push ${ORG}/${REPO}:${MAJOR}; \
          docker push ${ORG}/${REPO}:${MINOR}; \
          docker push ${ORG}/${REPO}:${PATCH}; \
          docker push ${ORG}/${REPO}:mongod; \
          docker push ${ORG}/${REPO}:mongod-${MAJOR}; \
          docker push ${ORG}/${REPO}:mongod-${MINOR}; \
          docker push ${ORG}/${REPO}:mongod-${PATCH}; \
          docker push ${ORG}/${REPO}:mongos; \
          docker push ${ORG}/${REPO}:mongos-${MAJOR}; \
          docker push ${ORG}/${REPO}:mongos-${MINOR}; \
          docker push ${ORG}/${REPO}:mongos-${PATCH};

    major-support:
      branch: /[0-9]/
      owner: dockerslim
      commands:
        - >
          docker tag default ${ORG}/${REPO}:${MAJOR}; \
          docker tag default ${ORG}/${REPO}:${MINOR}; \
          docker tag default ${ORG}/${REPO}:${PATCH}; \
          docker tag mongod ${ORG}/${REPO}:mongod-${MAJOR}; \
          docker tag mongod ${ORG}/${REPO}:mongod-${MINOR}; \
          docker tag mongod ${ORG}/${REPO}:mongod-${PATCH}; \
          docker tag mongos ${ORG}/${REPO}:mongos-${MAJOR}; \
          docker tag mongos ${ORG}/${REPO}:mongos-${MINOR}; \
          docker tag mongos ${ORG}/${REPO}:mongos-${PATCH}
        - >
          docker push ${ORG}/${REPO}:${MAJOR}; \
          docker push ${ORG}/${REPO}:${MINOR}; \
          docker push ${ORG}/${REPO}:${PATCH}; \
          docker push ${ORG}/${REPO}:mongod-${MAJOR}; \
          docker push ${ORG}/${REPO}:mongod-${MINOR}; \
          docker push ${ORG}/${REPO}:mongod-${PATCH}; \
          docker push ${ORG}/${REPO}:mongos-${MAJOR}; \
          docker push ${ORG}/${REPO}:mongos-${MINOR}; \
          docker push ${ORG}/${REPO}:mongos-${PATCH};

    minor-support:
      branch: /[0-9].[0.9]/
      owner: dockerslim
      commands:
        - >
          docker tag default ${ORG}/${REPO}:${MINOR}; \
          docker tag default ${ORG}/${REPO}:${PATCH}; \
          docker tag mongod ${ORG}/${REPO}:mongod-${MINOR}; \
          docker tag mongod ${ORG}/${REPO}:mongod-${PATCH}; \
          docker tag mongos ${ORG}/${REPO}:mongos-${MINOR}; \
          docker tag mongos ${ORG}/${REPO}:mongos-${PATCH}
        - >
          docker push ${ORG}/${REPO}:${MINOR}; \
          docker push ${ORG}/${REPO}:${PATCH}; \
          docker push ${ORG}/${REPO}:mongod-${MINOR}; \
          docker push ${ORG}/${REPO}:mongod-${PATCH}; \
          docker push ${ORG}/${REPO}:mongos-${MINOR}; \
          docker push ${ORG}/${REPO}:mongos-${PATCH};
